# https://github.com/CocoaPods/pod-template/blob/master/.travis.yml
# https://github.com/googlesamples/android-ndk/blob/master/.travis.yml

matrix:
  include:
    - language: objective-c

      os: osx

      osx_image: xcode8.2

      cache:
        - cocoapods

      before_install:
        - gem install cocoapods
        - pod install --project-directory=test/proj.ios_mac

      script:
        - xcodebuild -workspace test/proj.ios_mac/ee_x_test.xcworkspace -scheme ee_x_test_mobile -sdk iphonesimulator ONLY_ACTIVE_ARCH=NO

    - language: android

      jdk: oraclejdk8

      os: linux

      env:
        - ANDROID_NDK_VERSION=r10e
        - ANDROID_NDK_HOME=${HOME}/android-ndk-root

      android:
        components:
          - tools
          - platform-tools
          - build-tools-25.0.3
          - android-25
          - extra-android-m2repository
          - extra-google-m2repository

        # http://stackoverflow.com/questions/43872206/travis-for-android-licence-issues
        licenses:
          - 'android-sdk-preview-license-.+'
          - 'android-sdk-license-.+'
          - 'google-gdk-license-.+'

      # https://github.com/travis-ci/travis-ci/issues/6555
      # install:
      #   - echo y | android update sdk -u -a -t tools
      #   - echo y | android update sdk -u -a -t platform-tools
      #   - echo y | android update sdk -u -a -t build-tools-25.0.3
      #   - echo y | android update sdk -u -a -t android-25
      #   - echo y | android update sdk -u -a -t extra-google-m2repository
      #   - echo y | android update sdk -u -a -t extra-android-m2repository

      before_cache:
        - rm -f  ${HOME}/.gradle/caches/modules-2/modules-2.lock
        - rm -fr ${HOME}/.gradle/caches/*/plugin-resolution/

      cache:
        directories:
          - ${HOME}/android-ndk-root
          - ${HOME}/.gradle/caches
          - ${HOME}/.gradle/wrapper
          - ${HOME}/.android/build-cache

      before_install:
        - |
          if [ ! -d ${HOME}/android-ndk-root ]; then
            travis_retry wget https://dl.google.com/android/repository/android-ndk-${ANDROID_NDK_VERSION}-darwin-x86_64.zip
            chmod u+x android-ndk-${ANDROID_NDK_VERSION}-darwin-x86_64.zip
            ./android-ndk-${ANDROID_NDK_VERSION}-darwin-x86_64.zip > /dev/null
            rm android-ndk-${ANDROID_NDK_VERSION}-darwin-x86_64.zip
            mv ./android-ndk-${ANDROID_NDK_VERSION} ${HOME}/android-ndk-root
          fi

        - echo 'ndk.dir=$ANDROID_NDK_HOME' >> test/proj.android_studio/local.properties

      before_script:
        - chmod +x test/proj.android_studio/gradlew

      script:
        - test/proj.android_studio/gradlew -p test/proj.android_studio clean assembleRelease